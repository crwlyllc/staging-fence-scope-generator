<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Changelog | Strong Perimeter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="assets/strong-perimeter-favicon.svg" />
  <style>
    :root {
      --sp-green: #004b3d;
      --sp-green-dark: #003428;
      --sp-stage: #ececec;
      --sp-card: #ffffff;
      --sp-border: #d1d5db;
      --sp-ink: #111827;
      --sp-muted: #4b5563;
      --sp-radius: 16px;
      --sp-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Open Sans", "Segoe UI", Arial, sans-serif;
      background: var(--sp-stage);
      color: var(--sp-ink);
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px 20px 48px;
      display: grid;
      gap: 16px;
    }

    .hero {
      background: linear-gradient(165deg, var(--sp-green) 0%, var(--sp-green-dark) 100%);
      border: 1px solid #48655c;
      border-radius: var(--sp-radius);
      box-shadow: var(--sp-shadow);
      padding: 18px 20px;
      color: #f8fafc;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .brand {
      display: grid;
      gap: 8px;
      max-width: 700px;
    }

    .brand img {
      height: 36px;
      width: auto;
      display: block;
    }

    .hero h1 {
      margin: 0;
      font-size: 30px;
      line-height: 1.2;
    }

    .hero p {
      margin: 0;
      color: #dbe8e2;
      font-size: 14px;
      line-height: 1.55;
      max-width: 700px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      text-decoration: none;
      border: 1px solid #8aa99e;
      background: #f8fafc;
      color: #0f172a;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      font-size: 14px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .btn.secondary {
      background: transparent;
      color: #e2ece7;
      border-color: #90ad9f;
    }

    .panel {
      background: var(--sp-card);
      border: 1px solid var(--sp-border);
      border-radius: var(--sp-radius);
      box-shadow: var(--sp-shadow);
      padding: 18px;
      display: grid;
      gap: 14px;
    }

    .status {
      margin: 0;
      color: var(--sp-muted);
      font-size: 14px;
      line-height: 1.4;
    }

    .status.error {
      color: #b91c1c;
    }

    .updates {
      display: grid;
      gap: 12px;
    }

    .update {
      border: 1px solid #dfe4ea;
      border-left: 6px solid var(--sp-green);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.03);
      display: grid;
      gap: 8px;
    }

    .update time {
      color: #4b5563;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .update h2 {
      margin: 0;
      font-size: 19px;
      line-height: 1.25;
      color: #111827;
    }

    .update p {
      margin: 0;
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    .update .repeat {
      color: #6b7280;
      font-size: 12px;
    }

    @media (max-width: 719px) {
      .wrap {
        padding: 16px 14px 32px;
      }

      .hero h1 {
        font-size: 24px;
      }

      .panel {
        padding: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="brand">
        <img src="assets/strong-perimeter-logo-white.svg" alt="Strong Perimeter" />
        <h1>Sales Changelog</h1>
        <p>
          Simple release notes for the sales team. Each update shows what was added or improved and how it
          helps with quoting.
        </p>
      </div>
      <div class="actions">
        <a class="btn secondary" href="crew-policies.html">Crew Policies</a>
        <a class="btn" href="index.html">Back to Scope Generator</a>
      </div>
    </header>

    <section class="panel" aria-label="Sales changelog timeline">
      <p class="status" id="status">Loading latest updates...</p>
      <div class="updates" id="updates"></div>
    </section>
  </div>

  <script>
    (function () {
      const HISTORY_FILE = "changelog-history.tsv";
      const statusEl = document.getElementById("status");
      const updatesEl = document.getElementById("updates");

      const NOISE_PATTERNS = [
        /^update$/i,
        /^update index\.html$/i,
        /^update \.ds_store$/i,
        /^merge pull request/i,
        /^merge branch/i,
        /^undo\b/i
      ];

      const RULES = [
        {
          id: "hcp-estimate-id-payload",
          re: /estimate id when pushing notes & line items|estimate id/i,
          title: "Estimate ID Sent in HCP Payloads",
          description:
            "Estimate lookup now stores the Housecall Pro estimate id and includes it when sending both notes and service line items."
        },
        {
          id: "service-line-push-confirmation",
          re: /confirm service line item push|push service line items/i,
          title: "Service Line Push Requires Confirmation",
          description:
            "Before sending service line items to Housecall Pro, the app now asks for confirmation with estimate, option, and item count."
        },
        {
          id: "post-setting-method",
          re: /post set|post setting|anchored|anchor plate|anchors/i,
          title: "Choose How Posts Are Set",
          description:
            "On installs and replacements, sales can now choose dug-and-set in concrete or anchored to concrete. Anchored posts include one 4x4 anchor plate and four anchors per post."
        },
        {
          id: "post-spacing-12",
          re: /post spacing|12ft|12 ft/i,
          title: "12 ft Post Spacing Added",
          description: "Post spacing now includes a 12 ft option for section planning."
        },
        {
          id: "wrought-custom-panels",
          re: /custom panel|tmi|powder coat|custom build/i,
          title: "Wrought Iron Custom Panel Workflow Added",
          description:
            "For wrought iron installs and replacements, sales can choose on-site custom build or order custom panels from TMI. Ordered panels assume $300 each and install like prefab panels."
        },
        {
          id: "service-line-copy",
          re: /copy button|copy buttons|button clicking/i,
          title: "Service Line Copy Buttons Fixed",
          description:
            "Service line copy buttons now complete the copy action and show clear copied feedback."
        },
        {
          id: "wood-no-wrought-gate",
          re: /hide wrought iron gate|wrought iron gates on wood/i,
          title: "Wood Sections No Longer Show Wrought-Iron Gate Fields",
          description:
            "Wood sections now hide wrought-iron-only gate details, so section setup stays clean and relevant."
        },
        {
          id: "wood-rail-length",
          re: /rail length|wood install\/replace/i,
          title: "Wood Install and Replace Rail Length Added",
          description:
            "Wood install and replacement workflows now explicitly include rail length to improve material and labor clarity."
        },
        {
          id: "existing-post-fasteners",
          re: /use existing posts|include fasteners/i,
          title: "Existing Post Scopes Include Fasteners",
          description:
            "Scopes that use existing posts now include required fasteners in materials."
        },
        {
          id: "crew-notes",
          re: /crew notes/i,
          title: "Crew Notes Improved",
          description:
            "Crew notes were updated for clearer handoff from sales scope to field execution."
        },
        {
          id: "sales-changelog",
          re: /\bchangelog\b/i,
          title: "New Sales Changelog Page",
          description:
            "Added this page so sales can quickly see new features in plain language."
        }
      ];

      function parseHistory(raw) {
        return String(raw || "")
          .split(/\r?\n/)
          .map(function (line) { return line.trim(); })
          .filter(Boolean)
          .map(function (line) {
            const parts = line.split("\t");
            return {
              date: (parts[0] || "").trim(),
              message: parts.slice(2).join("\t").trim()
            };
          })
          .filter(function (item) {
            return /^\d{4}-\d{2}-\d{2}$/.test(item.date) && item.message;
          });
      }

      function cleanMessage(message) {
        return String(message || "")
          .replace(/^(feat|fix|chore|refactor|docs|style|perf|test)\s*:\s*/i, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function isNoise(message) {
        return NOISE_PATTERNS.some(function (pattern) { return pattern.test(message); });
      }

      function findRule(message) {
        return RULES.find(function (rule) { return rule.re.test(message); }) || null;
      }

      function buildEntries(history) {
        const grouped = new Map();

        history.forEach(function (item) {
          const cleaned = cleanMessage(item.message);
          if (!cleaned || isNoise(cleaned)) return;

          const rule = findRule(cleaned);
          if (!rule) return;

          const existing = grouped.get(rule.id);
          if (!existing) {
            grouped.set(rule.id, {
              title: rule.title,
              description: rule.description,
              date: item.date,
              hits: 1
            });
            return;
          }

          existing.hits += 1;
          if (item.date > existing.date) existing.date = item.date;
        });

        return Array.from(grouped.values()).sort(function (a, b) {
          return b.date.localeCompare(a.date);
        });
      }

      function formatDate(dateValue) {
        const dt = new Date(dateValue + "T00:00:00");
        if (Number.isNaN(dt.getTime())) return dateValue;
        return dt.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      }

      function render(entries) {
        updatesEl.innerHTML = "";

        if (!entries.length) {
          statusEl.classList.add("error");
          statusEl.textContent = "No sales-facing updates were found in changelog-history.tsv.";
          return;
        }

        statusEl.classList.remove("error");
        statusEl.textContent = entries.length + " update" + (entries.length === 1 ? "" : "s") + " available.";

        const frag = document.createDocumentFragment();
        entries.forEach(function (entry) {
          const card = document.createElement("article");
          card.className = "update";

          const date = document.createElement("time");
          date.dateTime = entry.date;
          date.textContent = formatDate(entry.date);

          const title = document.createElement("h2");
          title.textContent = entry.title;

          const description = document.createElement("p");
          description.textContent = entry.description;

          card.appendChild(date);
          card.appendChild(title);
          card.appendChild(description);

          if (entry.hits > 1) {
            const repeat = document.createElement("p");
            repeat.className = "repeat";
            repeat.textContent = "Refined " + entry.hits + " times.";
            card.appendChild(repeat);
          }

          frag.appendChild(card);
        });

        updatesEl.appendChild(frag);
      }

      async function load() {
        try {
          const response = await fetch(HISTORY_FILE + "?v=" + Date.now(), { cache: "no-store" });
          if (!response.ok) throw new Error("HTTP " + response.status);

          const raw = await response.text();
          const history = parseHistory(raw);
          const entries = buildEntries(history);
          render(entries);
        } catch (err) {
          console.error("Failed to load changelog", err);
          statusEl.classList.add("error");
          statusEl.textContent =
            "Unable to load changelog-history.tsv. Regenerate it with: git log --date=short --pretty=format:\"%ad\\t%h\\t%s\" > changelog-history.tsv";
        }
      }

      load();
    })();
  </script>
</body>
</html>
